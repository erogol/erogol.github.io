<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/png"
        href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F73500d39-5ecb-44f8-9188-f44c25addc6b_160x160.png">
    <meta http-equiv="Page-Enter" content="blendTrans(Duration=.5)" />
    <meta http-equiv="Page-Exit" content="blendTrans(Duration=.5)" />
    <title>ME_AI - Markdown editor with AI </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="meai.css">
    <style>
        body {
            opacity: 0;
        }
    </style>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FJWPNMDQTK"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-FJWPNMDQTK');
</script>

<body>
    <div class="container">
        <div class="editor">
            <textarea id="markdown-editor">
# Markdown Syntax Samples

## Headers
This is some text

# Header 1
## Header 2
### Header 3

## Emphasis

*Italic Text*
**Bold Text**
***Bold Italic Text***

## Lists

### Unordered List
- Item 1
- Item 2
  - Subitem 1
  - Subitem 2

### Ordered List
1. First Item
2. Second Item
   1. Subitem A
   2. Subitem B

## Links

[Visit OpenAI](https://www.openai.com)
[Visit GitHub](https://www.github.com)

## Images

![Alt Text](https://www.example.com/image.jpg)

## Blockquotes

> This is a blockquote.
> It can span multiple lines.

## Code

### Inline Code
Use backticks to highlight `inline code`.

### Code Block
```python
def greet(name):
    print(f"Hello, {name}!")

            </textarea>
            <div id="promptOverlay" class="contrainer" data-bs-theme="dark">
                <!-- <div id="promptIcon">✨</div> -->
                <div class="col" data-bs-theme="dark">
                    <div class="row">
                        <div
                            class="d-flex flex-column flex-md-row p-4 gap-4 py-md-5 align-items-center justify-content-center">

                            <textarea id="promptText"
                                placeholder="✨ Ask AI to write anything... e.g. 'Write me a blogpost.'"></textarea>
                        </div>
                    </div>
                    <div class="row">

                        <div
                            class="d-flex flex-column flex-md-row p-4 gap-4 py-md-5 align-items-center justify-content-center">
                            <ul id="promptHistoryList" class="dropdown-menu position-static d-grid rounded-2 w-220px">
                                <li class="dropdown-item disabled">No history yet</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="context-menu" id="contextMenu" data-bs-theme="dark">
                <ul data-bs-theme="dark"
                    class="dropdown-menu position-static d-grid gap-1 p-2 rounded-3 mx-0 border-0 shadow w-220px">
                    <li class="dropdown-item" href="#" id="autoComplete">Autocomplete</li>
                    <li class="dropdown-item" href="#" id="makeFluent">Make it Fluent</li>
                    <li class="dropdown-item" href="#" id="paraphrase">Paraphrase</li>
                    <li class="dropdown-item" href="#" id="correctSpelling">Correct Spelling</li>
                </ul>
            </div>
            <div class="text-area-overlay" id="loadingOverlay">
                <div class="text-area-loading-spinner"></div>
            </div>
            <!-- FILEPATH: /Users/erengolge/Projects/erogol.github.io/meai.html -->

            <div id="settings-window" class="card text-light" style="background-color: #212529;">
                <div class="card-header d-flex justify-content-between">
                    <h2>Settings</h2>
                    <button type="button" class="btn-close btn-close-white" aria-label="Close"
                        id="settingsCloseBtn"></button>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="apiKeyInput" class="form-label">OpenAI API Key</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="apiKeyInput"
                                placeholder="Enter your API key here">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="maxTokensInput" class="form-label"
                            title="Maximum number of tokens that can be returned by the API.">Max Tokens</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="maxTokensInput"
                                title="Maximum number of tokens that can be returned by the API."
                                placeholder="Enter the max number of tokens here">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="apiTimeoutInput" class="form-label"
                            title="Seconds to timeout hanging API call.">Request Timeout</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="apiTimeoutInput"
                                title="Seconds to timeout hanging API call." placeholder="Enter secs to timeout here.">
                        </div>
                    </div>
                    <!-- single save button -->
                    <button class="btn btn-outline-light" type="button" id="saveSettingsBtn">Save All Settings</button>
                </div>
            </div>




            <div id="help-window">
                <button type="button" class="btn-close btn-close-white closeButton" aria-label="Close"
                    id="helpCloseBtn"></button>
                <!-- <div class="closeButton" id="helpCloseBtn">X</div> -->
                <h1>🤖 ME-AI</h1>
                <p>
                    aka Markdown editor with AI.<br><br>
                </p>
                <h1>Usage</h1>
                <p>
                <div>
                    <p>To access the AI options, simply right-click anywhere in the editor.</p><br>

                    <h3>AI Command Menu</h3>
                    <p>The menu will then appear, providing you with a range of choices:</p>

                    <ul>
                        <li>Autocomplete: Autocompletes the selected text.</li>
                        <li>Make It Fluent: Makes the selected text fluent.</li>
                        <li>Paraphrase: Paraphrases the selected text.</li>
                        <li>Correct Spelling: Corrects the spelling of the selected text.</li>
                    </ul><br>

                    <h3>Ask AI to do anything</h3>
                    <ol>
                        <li>(Optional) Select a text.</li>
                        <li>Press <strong>Ctrl+Shift+P</strong></li>
                        <li>Type your command and press Enter.</li>
                    </ol><br>

                    <h3>Toolbar</h3>
                    <p>The editor is equipped with a convenient toolbar that becomes visible when you hover your
                        mouse
                        at the top. In addition to the classic editor options, it also offers a few additional
                        features:
                    </p>

                    <ul>
                        <li>Preview: Toggle the preview pane.</li>
                        <li>Save: Save the text to local storage, so you can continue writing next time.</li>
                        <li>Load: Load the text from local storage.</li>
                        <li>Download: Download the text as a .md file.</li>
                        <li>Upload: Upload a .md file to the editor.</li>
                        <li>Help: Show this help dialog.</li>
                    </ul><br><br>

                    <h1>Notes</h1>
                    <ul>
                        <li>ME-AI does not retain any of your data including your API key.</li>
                        <li>ME_AI requires you to enter an OpenAI API key to use the AI functions.</li>
                        <li>🤖 is a fully local. There is no server in the background.</li>
                        <li>If no text selected, 🤖 will try to update the last paragraph.</li>
                        <li>The editor automatically saves the current content to local storage every minute,
                            allowing
                            you to conveniently resume your work later.</li>
                    </ul><br><br>
                    <!-- Do not show me again checkbox -->

                    <!-- Do not show me again checkbox -->
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="doNotShowAgainCheckbox">
                        <label class="form-check-label" for="doNotShowAgainCheckbox">
                            Do not show me this at start.
                        </label>
                    </div>
                </div>
            </div>
        </div>
        </p>
    </div>
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.0.0/diff.min.js"></script>
    <script src="app.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var contextMenu = document.getElementById("contextMenu");
            var editorDiv = document.querySelector(".editor");
            var promptForum = document.getElementById("promptOverlay");
            var simplemde;
            var savedScrollInfo = null;
            var cursorPosition = null;
            var loadingOverlay = document.getElementById("loadingOverlay"); // Get the loading overlay
            var helpWindow = document.getElementById("help-window");
            var helpWindowCloseBtn = document.getElementById("helpCloseBtn");
            var previousText = ""; // Store the previous text for highlighting
            var promptHistoryList = document.getElementById("promptHistoryList"); // Get the prompt text field


            // ##############################################
            // ############# EDITOR BUTTONS ###############
            // ##############################################

            var saveAction = function (editor) {
                // Load the text from local storage and set it to SimpleMDE
                console.log("Saving text to local storage");
                localStorage.setItem("editorText", simplemde.codemirror.getValue());
            };

            var loadAction = function (editor) {
                // Load the text from local storage and set it to SimpleMDE
                console.log("Loading text from local storage");
                simplemde.value(localStorage.getItem("editorText"));
            };

            var deleteAction = function (editor) {
                // Show a confirmation dialog before deleting the text from local storage
                var confirmed = confirm("❗ This nukes all the text. Are you sure?");

                if (confirmed) {
                    // Delete the text from local storage
                    console.log("Deleting text from local storage");
                    localStorage.removeItem("ed☢️itorText");
                    simplemde.value("");
                }
            };

            var downloadAction = function (editor) {
                // Get the content from the editor
                var content = simplemde.value();

                // Create a Blob with the content
                var blob = new Blob([content], { type: "text/plain" });

                // Create a downloadable URL for the Blob
                var url = URL.createObjectURL(blob);

                // Create a link element for downloading
                var downloadLink = document.createElement("a");
                downloadLink.href = url;
                downloadLink.download = "markdown.txt"; // Specify the filename
                downloadLink.textContent = "Download"; // Displayed text
                downloadLink.style.display = "none"; // Hide the link

                // Append the link to the document and simulate a click
                document.body.appendChild(downloadLink);
                downloadLink.click();

                // Clean up
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(url);
            };

            var uploadAction = function (editor) {
                // Create an input element for file selection
                var fileInput = document.createElement("input");
                fileInput.type = "file";
                fileInput.accept = ".txt"; // Accept only text files
                fileInput.style.display = "none"; // Hide the input

                // Append the input to the document and simulate a click
                document.body.appendChild(fileInput);
                fileInput.click();

                // Listen for the file input change event
                fileInput.addEventListener("change", function (e) {
                    var file = e.target.files[0];
                    if (file) {
                        var reader = new FileReader();
                        reader.onload = function (event) {
                            // Set the loaded content to the editor
                            simplemde.value(event.target.result);
                        };
                        reader.readAsText(file);
                    }
                    // Clean up the input element
                    document.body.removeChild(fileInput);
                });
            };

            var helpAction = function (editor) {
                // Show a help dialog
                helpWindow.style.display = "block";
                document.getElementById("doNotShowAgainCheckbox").checked = localStorage.getItem("doNotShowAgain");
                helpWindowCloseBtn = document.createElement("div");
            };

            var resetApiKeyAction = function (editor) {
                // Show a confirmation dialog before deleting the text from local storage
                var confirmed = confirm("❗ This will reset your API key. Are you sure?");

                if (confirmed) {
                    // Delete the text from local storage
                    console.log("Deleting API key from local storage");
                    localStorage.removeItem("API_KEY");
                    API_KEY = null;
                }

                set_api_key();
            };

            // Open the settings window
            var openSettingsWindow = function (editor) {
                // Show the settings window
                document.getElementById("settings-window").style.display = "block";
                console.log("Opening settings window");
            };

            simplemde = new SimpleMDE({
                element: document.getElementById("markdown-editor"),
                toolbar: [
                    "bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|",
                    "link", "image", "table", "|", "preview", "side-by-side", "fullscreen", "|",
                    {
                        name: "save",
                        action: saveAction,
                        className: "fa fa-save",
                        title: "Save to Cache"
                    },
                    {
                        name: "load",
                        action: loadAction,
                        className: "fa fa-undo",
                        title: "Load from Cache"
                    },
                    {
                        name: "delete",
                        action: deleteAction,
                        className: "fa fa-trash",
                        title: "Empty Cache"
                    },
                    {
                        name: "download",
                        action: downloadAction,
                        className: "fa fa-download",
                        title: "Download"
                    },
                    {
                        name: "upload",
                        action: uploadAction,
                        className: "fa fa-upload",
                        title: "Upload",
                    }, "|",
                    {
                        name: "settings",
                        action: openSettingsWindow,
                        className: "fa fa-cog",
                        title: "Settings"
                    },
                    {
                        name: "reset-api-key",
                        action: resetApiKeyAction,
                        className: "fa fa-key",
                        title: "Reset API Key"
                    },
                    {
                        name: "help",
                        action: helpAction,
                        className: "fa fa-question-circle",
                        title: "Help"
                    },

                ],
                // Apply custom styles for full-screen mode
                fullscreenToggle: true,
                onToggleFullScreen: function (isFullScreen) {
                    if (isFullScreen) {
                        // Apply custom styles for full-screen mode
                        document.querySelector(".editor-toolbar").style.backgroundColor = "#3a3a3a";
                        document.querySelector(".editor-toolbar").style.color = "#d4d4d4";
                    } else {
                        // Restore original styles when exiting full-screen mode
                        document.querySelector(".editor-toolbar").style.backgroundColor = "#3a3a3a";
                        document.querySelector(".editor-toolbar").style.color = "#d4d4d4";
                    }
                }
            });


            // Load the text from local storage and set it to SimpleMDE
            var savedText = localStorage.getItem("editorText");
            if (savedText) {
                previousText = savedText;
                simplemde.value(savedText);
            }

            editorDiv.addEventListener("contextmenu", function (e) {
                if (!e.shiftKey) {
                    e.preventDefault();
                    contextMenu.style.left = e.pageX + "px";
                    contextMenu.style.top = e.pageY + "px";
                    contextMenu.classList.add("active");
                }
            });

            document.addEventListener("click", function (e) {
                if (!contextMenu.contains(e.target)) {
                    contextMenu.classList.remove("active");
                }
                contextMenu.classList.remove("active");
            });

            // Close the help window when the close button is clicked
            helpWindowCloseBtn.addEventListener("click", function () {
                helpWindow.style.display = "none";
                localStorage.setItem("doNotShowAgain", document.getElementById("doNotShowAgainCheckbox").checked);
                helpWindow.removeChild(helpWindowCloseBtn);
            });

            // Show the help window at start
            if (localStorage.getItem("doNotShowAgain") !== "true") {
                document.getElementById("doNotShowAgainCheckbox").checked = !localStorage.getItem("doNotShowAgain");
                helpWindow.style.display = "block";
            }

            /**************************************************************
             * UTILS
             * ***********************************************************/

            function add_prompt_to_favorite() {
                // Get the prompt text
                var instruction = get_prompt();
                if (instruction !== '') {
                    if (!favPromptList.includes(instruction)) {
                        favPromptList.push(instruction);
                        localStorage.setItem('favPrompts', JSON.stringify(favPromptList));
                    }
                }
            }

            function delete_prompt_from_favorite(instruction) {
                // Get the prompt text
                if (instruction !== '') {
                    if (favPromptList.includes(instruction)) {
                        var index = favPromptList.indexOf(instruction);
                        if (index > -1) {
                            favPromptList.splice(index, 1);
                        }
                        localStorage.setItem('favPrompts', JSON.stringify(favPromptList));
                    }
                }
            }

            function update_prompt_history_list() {
                // Clear existing list
                while (promptHistoryList.firstChild) {
                    promptHistoryList.removeChild(promptHistoryList.firstChild);
                }
                // Re-create list from updated promptHistory array
                promptHistory.forEach(function (value) {
                    createPromptHistoryList(value);
                });
            }

            function createPromptHistoryList(value) {
                var li = document.createElement('li');
                li.className = 'h-100 text-truncate  list-group-item list-group-item-action prompt-history-item';
                // li.style = 'display: flex;';

                var a = document.createElement('a');
                a.className = 'text-truncate  dropdown-item rounded-2';
                a.href = '#';

                var del_button = document.createElement('button');
                del_button.className = 'btn btn-sm delete-button';
                del_button.style = 'color: gray;';

                var i = document.createElement('i');
                i.className = 'bi bi-x-circle';
                del_button.appendChild(i);
                // a.appendChild(del_button);
                del_button.addEventListener('click', function (e) {
                    e.stopPropagation();
                    var index = promptHistory.indexOf(value);
                    if (index > -1) {
                        promptHistory.splice(index, 1);
                    }
                    localStorage.setItem('promptHistory', JSON.stringify(promptHistory));
                    update_prompt_history_list();
                });

                // add favorite button
                var fav_button = document.createElement('button');
                fav_button.className = 'btn btn-sm fav-button bi bi-star';
                fav_button.style = 'color: gray;';
                fav_button.addEventListener('click', function (e) {
                    // stops the click event from triggering the event on the parent element
                    e.stopPropagation();

                    if (!favorites.includes(value)) {
                        favorites.push(value);
                        localStorage.setItem('favorites', JSON.stringify(favorites));
                    }
                });

                a.appendChild(del_button);
                a.appendChild(fav_button);
                a.appendChild(document.createTextNode(value));
                li.appendChild(a);
                // Add click event listener to li
                li.addEventListener('click', function () {
                    // Get textarea by id and set its value to the clicked list item's text
                    set_prompt_text(value);
                    document.getElementById('promptText').focus();
                    resizeTextarea();
                });
                promptHistoryList.appendChild(li);
            }

            function get_favorite_prompt_history() {
                favPromptHistory = JSON.parse(localStorage.getItem("favPromptHistory")) || [];
                return favPromptHistory;
            }

            function get_prompt_history() {
                promptHistory = JSON.parse(localStorage.getItem("promptHistory")) || [];
                return promptHistory;
            }

            // Function to show the loading overlay
            function showLoadingOverlay() {
                loadingOverlay.style.display = "flex";

                // Set the loading spinner off with a delay
                setTimeout(function () {
                    loadingOverlay.style.opacity = 1;
                }, 100);
            }

            // Function to hide the loading overlay
            function hideLoadingOverlay() {
                loadingOverlay.style.display = "none";
            }

            // Function to get the paragraph where the cursor is located
            function getCurrentParagraph() {
                cursorPosition = simplemde.codemirror.getCursor();
                var lineNumber = cursorPosition.line;
                var content = simplemde.value();
                var lines = content.split("\n");

                var currentParagraph = "";

                for (var i = lineNumber; i >= 0; i--) {
                    if (lines[i].trim() === "") {
                        break;
                    } else if (lines[i].startsWith("#")) {
                        currentParagraph = lines[i] + "\n" + currentParagraph;
                        break;
                    } else if (/^(\*|\-|\+|\d+\.)\s/.test(lines[i])) {
                        currentParagraph = lines[i] + "\n" + currentParagraph;
                        break;
                    } else {
                        currentParagraph = lines[i] + "\n" + currentParagraph;
                    }
                }

                return currentParagraph.trim();
            }

            document.getElementById("settingsCloseBtn").onclick = function () {
                document.getElementById("settings-window").style.display = "none";
            }


            /**************************************************************
             * Prompt Dialog
             * ***********************************************************/


            function openPromptDialog() {
                document.getElementById('promptOverlay').style.display = 'flex';

                // set the cursor to the prompt text
                document.getElementById('promptText').focus();

                const textarea = document.getElementById('promptText');
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';

                // append prompt history to the prompt history list
                favPromptHistory = get_favorite_prompt_history();
                promptHistory = get_prompt_history();
                // merge prompt history and fav prompt history
                promptHistory = favPromptHistory.concat(promptHistory);
                if (promptHistory.length > 0) {
                    promptHistoryList.innerHTML = '';
                    promptHistory.forEach(createPromptHistoryList);
                }

            }


            function closePromptDialog() {
                document.getElementById('promptOverlay').style.display = 'none';

                // if there is no text except ✨ in the field then clear the field
                if (document.getElementById('promptText').value === '✨ ') {
                    document.getElementById('promptText').value = '';
                }

                // Update prompt history
                console.log("Updating prompt history")
                instruction = get_prompt()
                if (instruction !== '') {
                    if (!promptHistory.includes(instruction)) {
                        promptHistory.unshift(instruction);
                        console.log(promptHistory);
                        localStorage.setItem('promptHistory', JSON.stringify(promptHistory));
                    } else {
                        console.log("Instruction already exists in prompt history")
                        var index = promptHistory.indexOf(instruction);
                        if (index > -1) {
                            promptHistory.splice(index, 1);
                        }
                        promptHistory.unshift(instruction);
                        localStorage.setItem('promptHistory', JSON.stringify(promptHistory));
                    }
                }
            }

            // close prompt dialog when user clicks outside of the dialog or press ESC
            promptForum.addEventListener("click", function (e) {
                if (!promptForum.contains(e.target)) {
                    closePromptDialog();
                }
            });

            document.addEventListener("keydown", function (e) {
                if (e.key === "Escape") {
                    closePromptDialog();
                }
            });

            function resizeTextarea() {
                const textarea = document.getElementById('promptText');
                textarea.style.height = 'auto';
                textarea.style.height = textarea.scrollHeight + 'px';

                // prepend ✨ and a space to the prompt text as the first character if it is not already there
                if (textarea.value[0] !== '✨') {
                    textarea.value = '✨ ' + textarea.value;
                }
            }

            function get_prompt() {
                instruction = document.getElementById('promptText').value;
                // remove ✨ from the prompt text
                instruction = instruction.replace('✨ ', '');
                return instruction;
            }

            function set_prompt_text(text) {
                document.getElementById('promptText').value = '✨ ' + text;
            }

            promptText.addEventListener('input', resizeTextarea);


            // get the entered text from the prompt dialog when it is active and pressed enter
            document.getElementById('promptText').addEventListener("keydown", async function (e) {
                if (event.key === 'Enter' && event.shiftKey) {
                    // If Shift + Enter is pressed, insert a new line character
                    const cursorPosition = promptText.selectionStart;
                    const textBeforeCursor = promptText.value.substring(0, cursorPosition);
                    const textAfterCursor = promptText.value.substring(cursorPosition);

                    promptText.value = textBeforeCursor + '\n' + textAfterCursor;

                    // Prevent the default behavior of Enter key (submitting the form in a textarea)
                    event.preventDefault();
                }
                else if (e.key === "Enter") {
                    event.preventDefault();

                    instruction = get_prompt();

                    showLoadingOverlay();

                    // Set the input text
                    var selectedText = simplemde.codemirror.getSelection();
                    previousText = simplemde.codemirror.getValue();

                    // Keep the scroll position the same after updating the text
                    savedScrollInfo = simplemde.codemirror.getScrollInfo();

                    if (instruction === null) {
                        // User clicked cancel
                        console.log("User cancelled the prompt");
                    } else {
                        // User entered an instruction
                        console.log("User entered instruction:", instruction);
                        console.log("Selected text:", selectedText);
                        // Do something with the user's instruction (you can send it to your AI model)
                        const ai_response = await userInstruction(instruction, selectedText);

                        console.log(ai_response);
                        if (ai_response) {
                            if (selectedText) {
                                const updatedContent = simplemde.value().replace(selectedText, ai_response);
                                simplemde.value(updatedContent);
                            }
                            else {
                                insertTextAtCursor(ai_response);
                            }
                        }
                    }
                    if (savedScrollInfo) {
                        simplemde.codemirror.scrollTo(savedScrollInfo.left, savedScrollInfo.top);
                        savedScrollInfo = null; // Reset after restoration
                    }
                    hideLoadingOverlay();
                    highlightAddedText();
                    closePromptDialog();

                    // pass focus to the editor
                    simplemde.codemirror.focus();
                }
            });

            // Listen for Ctrl+Shift+P (Cmd+Shift+P on Mac)
            document.addEventListener("keydown", function (e) {
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === "p") {
                    // show prompt forum
                    openPromptDialog();
                }
            });


            /**************************************************************
             * CONTEXT MENU
             * ***********************************************************/


            contextMenu.addEventListener("click", async function (e) {
                // Keep the scroll position the same after updating the text
                var selectedText = simplemde.codemirror.getSelection();
                savedScrollInfo = simplemde.codemirror.getScrollInfo();

                previousText = simplemde.codemirror.getValue();
                showLoadingOverlay();

                if (e.target.id === "autoComplete") {
                    if (selectedText) {
                        await autoCompleteText(selectedText);
                    }
                    else {
                        var lastParagraph = getCurrentParagraph();
                        console.log(lastParagraph);

                        if (lastParagraph) {
                            await autoCompleteText(lastParagraph);
                        }
                    }
                }
                if (e.target.id === "makeFluent") {
                    if (selectedText) {
                        await makeFluentLastParagraph(selectedText);
                    }
                    else {
                        var lastParagraph = getCurrentParagraph();
                        if (lastParagraph) {
                            await makeFluentLastParagraph(lastParagraph);
                        }
                    }
                }
                if (e.target.id === "paraphrase") {
                    if (selectedText) {
                        await paraphraseLastParagraph(selectedText);
                    }
                    else {
                        var lastParagraph = getCurrentParagraph();
                        if (lastParagraph) {
                            await paraphraseLastParagraph(lastParagraph);
                        }
                    }
                }
                if (e.target.id === "correctSpelling") {
                    if (selectedText) {
                        await correctSpellingText(selectedText);
                    }
                    else {
                        var lastParagraph = getCurrentParagraph();
                        if (lastParagraph) {
                            await correctSpellingText(lastParagraph);
                        }
                    }
                }
                if (savedScrollInfo) {
                    simplemde.codemirror.scrollTo(savedScrollInfo.left, savedScrollInfo.top);
                    savedScrollInfo = null; // Reset after restoration
                }
                hideLoadingOverlay();
                highlightAddedText();
            });


            // Function to auto complete the last paragraph
            // Function to auto-complete text
            async function autoCompleteText(inputText) {
                // const response = await fetch("http://127.0.0.1:5000/auto_complete", {
                //     method: "POST",
                //     headers: {
                //         "Content-Type": "application/json"
                //     },
                //     body: JSON.stringify({ input: inputText })
                // });

                // const data = await response.json();
                // const autoCompletion = data.auto_completion;

                const autoCompletion = await auto_complete(inputText)

                console.log(autoCompletion);

                if (autoCompletion) {
                    simplemde.codemirror.replaceSelection(autoCompletion);

                    // Get the start and end positions of the inserted text
                    var fromPos = simplemde.codemirror.indexFromPos(cursorPosition);
                    var toPos = fromPos + autoCompletion.length;

                    // Remove the highlighting class after the specified duration
                    console.log("Marking inserted text:", fromPos, toPos);
                    simplemde.codemirror.markText(
                        simplemde.codemirror.posFromIndex(fromPos),
                        simplemde.codemirror.posFromIndex(toPos),
                        { className: "highlight-inserted" }
                    );

                    setTimeout(function () {
                        console.log("Clearing highlights");
                        simplemde.codemirror.getAllMarks().forEach(function (mark) {
                            if (mark.className === "highlight-inserted") {
                                mark.clear();
                            }
                        });
                    }, 3000);
                }

            }

            // Function to make the last paragraph fluent
            async function makeFluentLastParagraph(lastParagraph) {
                // const response = await fetch("http://127.0.0.1:5000/make_fluent", {
                //     method: "POST",
                //     headers: {
                //         "Content-Type": "application/json"
                //     },
                //     body: JSON.stringify({ input: lastParagraph })
                // });

                // const data = await response.json();
                // const fluentResponse = data.fluent_response;

                const fluentResponse = await make_fluent(lastParagraph)

                if (fluentResponse) {
                    const updatedContent = simplemde.value().replace(lastParagraph, fluentResponse);
                    simplemde.value(updatedContent);
                }
            }

            // Function to make the last paragraph fluent
            async function paraphraseLastParagraph(lastParagraph) {
                // const response = await fetch("http://127.0.0.1:5000/paraphrase", {
                //     method: "POST",
                //     headers: {
                //         "Content-Type": "application/json"
                //     },
                //     body: JSON.stringify({ input: lastParagraph })
                // });

                // const paraphraseRespose = await response.json();
                // const paraphraseRespose = data.paraphrase_response;

                const paraphraseRespose = await paraphrase(lastParagraph)

                console.log(paraphraseRespose);

                if (paraphraseRespose) {
                    const updatedContent = simplemde.value().replace(lastParagraph, paraphraseRespose);
                    simplemde.value(updatedContent);
                }
            }

            //Fucntion to correct spelling
            async function correctSpellingText(inputText) {
                const response = await correctSpelling(inputText)
                console.log(response)
                if (response) {
                    const updatedContent = simplemde.value().replace(inputText, response);
                    simplemde.value(updatedContent);
                }
            }

            // Function to insert text at the cursor position
            function insertTextAtCursor(text) {
                var cursorPosition = simplemde.codemirror.getCursor();
                var currentLine = cursorPosition.line;
                var currentCh = cursorPosition.ch;
                var position = { line: currentLine, ch: currentCh };
                simplemde.codemirror.replaceSelection(text);
            }

            // Function to highlight added text
            function highlightAddedText() {
                var addedText = simplemde.codemirror.getValue();
                var diff = Diff.diffWordsWithSpace(previousText, addedText);

                // Reset previous highlights
                simplemde.codemirror.getAllMarks().forEach(function (mark) {
                    if (mark.className === "highlight-added") {
                        mark.clear();
                    }
                });

                var addedCount = 0;
                diff.forEach(function (part) {
                    if (part.added) {
                        // Apply highlighting class to the added part
                        var from = addedCount;
                        var to = from + part.value.length;
                        simplemde.codemirror.markText(
                            simplemde.codemirror.posFromIndex(from),
                            simplemde.codemirror.posFromIndex(to),
                            { className: "highlight-added" }
                        );
                        addedCount += part.value.length;
                    } else if (!part.removed) {
                        addedCount += part.value.length;
                    }
                });

                // Store the current text as previousText for the next change event
                previousText = addedText;

                setTimeout(function () {
                    console.log("Clearing highlights");
                    simplemde.codemirror.getAllMarks().forEach(function (mark) {
                        if (mark.className === "highlight-added") {
                            mark.clear();
                        }
                    });
                }, 3000);
            }

            // Call the save to cache function every minute
            setInterval(function () {
                console.log("Saving text to local storage...");
                saveAction(simplemde)
            }, 60000);


            // ***********************************************
            // *************** SETTINGS WINDOW ***************
            // ***********************************************

            // Populate settings fields with values from local storage
            let API_KEY = localStorage.getItem('API_KEY') || null;
            let MAX_TOKENS = localStorage.getItem('MAX_TOKENS') || 100;
            let API_TIMEOUT = localStorage.getItem('API_TIMEOUT') * 1000 || 60000;

            document.getElementById("apiKeyInput").value = "";
            if (API_KEY) {
                // Load API Key
                if (API_KEY != null && API_KEY != undefined && API_KEY != "" && API_KEY != "null") {
                    console.log(API_KEY);
                    document.getElementById("apiKeyInput").value = API_KEY;
                }
                console.log(document.getElementById("apiKeyInput").value == "null")
            }
            if (MAX_TOKENS) {
                // Load Max Tokens
                document.getElementById("maxTokensInput").value = MAX_TOKENS;
            }
            if (API_TIMEOUT) {
                // Load API Timeout
                document.getElementById("apiTimeoutInput").value = API_TIMEOUT / 1000;
            }

            document.getElementById("saveSettingsBtn").addEventListener("click", function () {
                // Get values from input fields.
                var apiKey = document.getElementById("apiKeyInput").value;
                var maxTokens = document.getElementById("maxTokensInput").value;
                var apiTimeout = document.getElementById("apiTimeoutInput").value * 1000;

                // Save values to local storage.
                localStorage.setItem("API_KEY", apiKey);
                localStorage.setItem("MAX_TOKENS", maxTokens);
                localStorage.setItem("API_TIMEOUT", apiTimeout);

                // Show a success message.
                showSavedIndicator();
            });

            function showSavedIndicator() {
                // Get the save button.
                var saveButton = document.getElementById("saveSettingsBtn");

                // Change the text to indicate that the settings have been saved.
                saveButton.textContent = "Settings Saved!";

                // Change it back after few seconds.
                setTimeout(function () {
                    saveButton.textContent = "Save All Settings";
                }, 3000);
            }
        });
        // window.onload = function () { setTimeout(function () { document.body.style.opacity = "100"; }, 500); };
    </script>
    <script>
        window.onload = function () { setTimeout(function () { document.body.style.opacity = "100"; }, 500); };
    </script>
</body>

</html>